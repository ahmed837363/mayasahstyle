<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin - Failed Emails</title>
  <style>body{font-family:Arial,Helvetica,sans-serif;margin:20px}table{width:100%;border-collapse:collapse}th,td{padding:8px;border:1px solid #ddd;text-align:left}button{padding:6px 10px}</style>
</head>
<body>
  <h1>Failed Email Payments</h1>
  <div id="list"></div>
  <script>
    async function load() {
      const res = await fetch('/admin/failed-payments');
      const data = await res.json();
      const container = document.getElementById('list');
      if (!data || !data.length) { container.innerHTML = '<p>No failed payments</p>'; return; }
      let html = '<table><tr><th>Order</th><th>Txn</th><th>Amount</th><th>When</th><th>Action</th></tr>';
      data.forEach(r => {
        html += `<tr><td>${r.order_id||''}</td><td>${r.transaction_id||''}</td><td>${r.amount||''}</td><td>${r.processed_at||''}</td><td><button onclick="retry('`+ (r.order_id||'') + `')">Retry</button></td></tr>`;
      });
      html += '</table>';
      container.innerHTML = html;
    }
    async function retry(order_id){
      const res = await fetch('/admin/retry-failed-emails',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({order_id})});
      const data = await res.json();
      alert('Attempted: '+ (data.attempted||0));
      load();
    }
    load();
  </script>
</body>
</html>
